#!/usr/bin/env python
"""

Add comment to JIRA

Usage:
  jira-comment --bug-id=BUG_ID [--comment-file=<comment_file>] [options]
  jira-comment (-h | --help)
  jira-comment (-v |--version)

Options:
  -f --comment-file=<comment_file>  File with comment text [default: /dev/stdin]
  -s --server=<server>              Server URI for Jira
                                    [default: getenv('JIRA_SERVER', 'https://gpk-apl-jirad1.cisco.com/jira')]
  -u --username=<username>          Username for Jira [default: getenv('JIRA_USERNAME')]
  -p --password=<password>          Password for Jira [default: getenv('JIRA_PASSWORD')]
  -d --debug                        Enable debug output
  -h --help                         Show this screen.
  -v --version                      Show version.

Example:

  echo "my comment" | jira-comment --bug-id=JIRA-271

  Alternatively:

  jira-comment --bug-id=JIRA-271 --comment-file comment.txt

"""
from docopt import docopt, parse_defaults
from jira import JIRA
from os import sys,getenv
import logging
import requests
requests.packages.urllib3.disable_warnings()

logger = logging.getLogger(__name__)
logging.basicConfig(stream=sys.stdout)


def isstring(s):
    if (sys.version_info[0] == 3):
        return isinstance(s, str)
    return isinstance(s, basestring)


def resolve_getenv_defaults(args):
    defaults = parse_defaults(__doc__)
    for option in defaults:
        if args[option.name] == option.value and isstring(option.value) and 'getenv(' in option.value:
            args[option.name] = eval(option.value)

if __name__ == '__main__':
    args = docopt(__doc__, version='0.1.0')
    resolve_getenv_defaults(args)

    if args['--debug']:
        logger.setLevel(logging.DEBUG)

    options = dict()
    options['verify'] = False
    options['server'] = args['--server']
    logger.debug("Reading comment text from: %s" % args['--comment-file'])
    comment = open(args['--comment-file']).read()

    logger.debug('Logging in to Jira')
    jira = JIRA(options=options, basic_auth=(args['--username'], args['--password']))
    jira.logging = logger

    logger.debug('Adding comment to Jira')
    comment = jira.add_comment(args['--bug-id'], comment)